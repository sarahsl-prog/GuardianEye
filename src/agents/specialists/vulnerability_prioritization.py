"""Vulnerability Prioritization Agent for risk-based vulnerability management."""

from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate

from src.agents.base.base_agent import AgentInput, AgentOutput, BaseAgent
from src.core.prompts import VULNERABILITY_PRIORITIZATION_PROMPT


class VulnerabilityPrioritizationAgent(BaseAgent):
    """Agent for prioritizing vulnerabilities based on risk."""

    def __init__(self, llm):
        """Initialize vulnerability prioritization agent."""
        super().__init__(llm, name="vulnerability_prioritization")
        self.parser = StrOutputParser()

    def get_prompt_template(self) -> ChatPromptTemplate:
        """Get prompt template for vulnerability prioritization."""
        return ChatPromptTemplate.from_messages([
            ("system", VULNERABILITY_PRIORITIZATION_PROMPT),
            ("user", """Vulnerability Details: {vuln_details}
            CVSS Score: {cvss_score}
            Environment: {environment}

            Please prioritize this vulnerability and provide recommendations.""")
        ])

    async def process(self, input_data: AgentInput) -> AgentOutput:
        """
        Process vulnerability prioritization request.

        Args:
            input_data: Vulnerability details

        Returns:
            AgentOutput with prioritization results
        """
        # Create chain
        chain = self.get_prompt_template() | self.llm | self.parser

        # Prepare input
        vuln_details = input_data.context.get("vuln_details", input_data.query)
        cvss_score = input_data.context.get("cvss_score", "Not provided")
        environment = input_data.context.get("environment", "Production")

        # Execute
        response = await chain.ainvoke({
            "vuln_details": vuln_details,
            "cvss_score": cvss_score,
            "environment": environment
        })

        return AgentOutput(
            result=response,
            metadata={
                "agent": self.name,
                "cvss_score": cvss_score,
                "environment": environment,
            }
        )
